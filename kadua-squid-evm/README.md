# Install the latest version of Subsquid CLI

```graphql
npm i -g @subsquid/cli@latest
```

# Check the version

```graphql
sqd --version
```

Make sure the output looks like @subsquid/cli/2.5.0 linux-x64 node-v20.6.1, or something similar.

# Authenticate Squid CLI

```graphql
sqd auth -k <DEPLOYMENT_KEY>
```

Replace <DEPLOYMENT_KEY> with your <DEPLOYMENT_KEY>, mine is: sqd_5657085b427a00355761. You can find your <DEPLOYMENT_KEY> at: https://app.subsquid.io/squids

# Create an EVM squid

```graphql
sqd init <MY_NEW_SQUID> -t evm
```

Replace <MY_NEW_SQUID> with your preferred name. You can also find other option at: https://app.subsquid.io/squids

# Enter the squid directory

```graphql
cd <MY_NEW_SQUID>
```

Replace <MY_NEW_SQUID> with your preferred name.

# Replace the contents in the already existing schema.graphql with

```graphql
type Gravatar @entity {
  id: ID!
  owner: Bytes!
  displayName: String!
  imageUrl: String!
}
```

# Generate the entities from the schema using the squid-typeorm-codegen tool of the Squid SDK

```graphql
sqd codegen
```

# Build the squid

```graphql
sqd build
```

# Start the local database and generate migrations from the generated entities using the squid-typeorm-migration tool

```graphql
sqd up
sqd migration:generate
```

# Generate typings from ABI

Copy ./abis/Gravity.json from the Subgraph project and paste it to ./abi folder in your Subsquid project, or create your own and paste this into it:

```graphql
[
    {
        "constant":false,
        "inputs":[{"name":"_imageUrl","type":"string"}],
        "name":"updateGravatarImage",
        "outputs":[],
        "payable":false,
        "stateMutability":"nonpayable"
        ,"type":"function"
    },
    {
        "constant":false,
        "inputs":[],
        "name":"setMythicalGravatar",
        "outputs":[],
        "payable":false,
        "stateMutability":"nonpayable",
        "type":"function"
    },
    {
        "constant":true,
        "inputs":[{"name":"owner","type":"address"}],
        "name":"getGravatar",
        "outputs":[{"name":"","type":"string"},{"name":"","type":"string"}],
        "payable":false,
        "stateMutability":"view","type":"function"
    },
    {
        "constant":true,
        "inputs":[{"name":"","type":"uint256"}],
        "name":"gravatarToOwner",
        "outputs":[{"name":"","type":"address"}],
        "payable":false,
        "stateMutability":"view",
        "type":"function"
    },
    {
        "constant":true,
        "inputs":[{"name":"","type":"address"}],
        "name":"ownerToGravatar",
        "outputs":[{"name":"","type":"uint256"}],
        "payable":false,"stateMutability":"view",
        "type":"function"
    },
    {
        "constant":false,
        "inputs":[{"name":"_displayName","type":"string"}],
        "name":"updateGravatarName",
        "outputs":[],
        "payable":false,
        "stateMutability":"nonpayable",
        "type":"function"
    },
    {
        "constant":false,
        "inputs":[{"name":"_displayName","type":"string"},{"name":"_imageUrl","type":"string"}],
        "name":"createGravatar",
        "outputs":[],"payable":false,
        "stateMutability":"nonpayable",
        "type":"function"
    },
    {
        "constant":true,
        "inputs":[{"name":"","type":"uint256"}],
        "name":"gravatars",
        "outputs":[{"name":"owner","type":"address"},{"name":"displayName","type":"string"},{"name":"imageUrl","type":"string"}],
        "payable":false,
        "stateMutability":"view","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"id","type":"uint256"},{"indexed":false,"name":"owner","type":"address"},{"indexed":false,"name":"displayName","type":"string"},{"indexed":false,"name":"imageUrl","type":"string"}],"name":"NewGravatar","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"id","type":"uint256"},{"indexed":false,"name":"owner","type":"address"},{"indexed":false,"name":"displayName","type":"string"},{"indexed":false,"name":"imageUrl","type":"string"}],
        "name":"UpdatedGravatar",
        "type":"event"
    }
]
```

Then:

```graphql
sqd typegen
```

# Subscribe to EVM logs

Replace your src/processor.ts code with this:

```graphql
import { EvmBatchProcessor} from '@subsquid/evm-processor'

// generated by the evm-typegen tool
// the events object contains typings for all events defined in the ABI
import { events } from './abi/Gravity'

// the registry of Subsquid-maintained public archives
import { lookupArchive } from '@subsquid/archive-registry'

export const GRAVATAR_CONTRACT = '0x2E645469f354BB4F5c8a05B3b30A929361cf77eC'.toLowerCase()

export const processor = new EvmBatchProcessor()

  .setDataSource({
    // change the alias to run against other EVM networks, e.g.
    // lookupArchive('polygon')
    // lookupArchive('binance')
    archive: lookupArchive('eth-mainnet'),
    chain: 'https://rpc.ankr.com/eth'
  })
  .setBlockRange({ from: 6_000_000 })
  .setFinalityConfirmation(75)
  .addTransaction({
    to:['0x0000000000000000000000000000000000000000']
  })
  .addLog({
    address: [ GRAVATAR_CONTRACT ],
    topic0: [
      events.NewGravatar.topic,
      events.UpdatedGravatar.topic,
    ],
  })
```

In the snippet above we tell the squid processor to fetch logs emitted by the contract 0x2E645469f354BB4F5c8a05B3b30A929361cf77eC with topic0 within a specified list. The configuration also states that indexing should start from block 6175243, the height at which the contract was deployed.

# Transform and save the data

Replace your src/main.ts code with this:

```graphql
function extractData(evmLog: any): { id: bigint, owner: string, displayName: string, imageUrl: string} {
  if (evmLog.topics[0] === events.NewGravatar.topic) {
    return events.NewGravatar.decode(evmLog)
  }
  if (evmLog.topics[0] === events.UpdatedGravatar.topic) {
    return events.UpdatedGravatar.decode(evmLog)
  }
  throw new Error('Unsupported topic')
}

import { TypeormDatabase } from '@subsquid/typeorm-store'
import { decodeHex } from '@subsquid/evm-processor'
import { events } from './abi/Gravity'
import { Gravatar } from './model'
import { processor, GRAVATAR_CONTRACT } from './processor'

processor.run(new TypeormDatabase({supportHotBlocks: true}), async (ctx) => {
  const gravatars: Map<string, Gravatar> = new Map()
  for (const c of ctx.blocks) {
    for (const e of c.logs) {
      if (!(e.address === GRAVATAR_CONTRACT &&
            (e.topics[0] === events.NewGravatar.topic ||
             e.topics[0] === events.UpdatedGravatar.topic))) continue
      const { id, owner, displayName, imageUrl } = extractData(e)
      let idString = '0x' + id.toString(16)
      gravatars.set(idString, new Gravatar({
        id: idString,
        owner: decodeHex(owner),
        displayName,
        imageUrl
      }))
    }
  }
  await ctx.store.upsert([...gravatars.values()])
})
```

# Run the processor and GraphQL API

```graphql
sqd process
```

To start an API server (at port 4350 by default) with a GraphQL schema auto-generated from the schema file, run in a new terminal window:

```graphql
sqd serve
```

Inspect the auto-generated GraphQL API using an interactive playground at http://localhost:4350/graphql.



# NOTE

When 'sqd codegen' produce such error:

```graphql
Error: spawn squid-typeorm-codegen ENOENT
Code: ENOENT
```

Run:

```graphql
npm i
```

# SOURCE
Visit: https://docs.subsquid.io/squid-cli/installation/ and https://docs.subsquid.io/migrate/migrate-subgraph/ for a more complex and detailed tutorial.
